
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Alexander Hagerman">
      
      
        <link rel="canonical" href="https://burningdaylight.io/blog/page/4/">
      
      
        <link rel="prev" href="../../../me/">
      
      
        <link rel="next" href="../../archive/2025/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../icons/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Index - burningdaylight</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/styles.css">
    
      <link rel="stylesheet" href="../../../css/portfolio.css">
    
      <link rel="stylesheet" href="../../../css/resume.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="hsl(195,-80%,-42%)" data-md-color-accent="hsl(284,-22%,-36%)">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#index" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://burningdaylight.io" title="burningdaylight" class="md-header__button md-logo" aria-label="burningdaylight" data-md-component="logo">
      
  <img src="../../../icons/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            burningdaylight
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Index
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="hsl(195,-80%,-42%)" data-md-color-accent="hsl(284,-22%,-36%)"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="hsl(284,-22%,-36%)" data-md-color-accent="hsl(195,-80%,-42%)"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://burningdaylight.io" title="burningdaylight" class="md-nav__button md-logo" aria-label="burningdaylight" data-md-component="logo">
      
  <img src="../../../icons/favicon.png" alt="logo">

    </a>
    burningdaylight
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../me/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Me
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
      
    
  
  
    <li class="md-nav__item">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Index
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="../../" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#train-all-the-things-signaling" class="md-nav__link">
    <span class="md-ellipsis">
      Train All the Things — Signaling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-status-page" class="md-nav__link">
    <span class="md-ellipsis">
      A Simple Status Page
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#train-all-the-things-planning" class="md-nav__link">
    <span class="md-ellipsis">
      Train All the Things - Planning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-apply-a-git-patch" class="md-nav__link">
    <span class="md-ellipsis">
      Create and Apply a Git Patch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-zero" class="md-nav__link">
    <span class="md-ellipsis">
      (define zero(….))
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-structure-and-interpretation-of-computer-programs-in-2020" class="md-nav__link">
    <span class="md-ellipsis">
      The Structure and Interpretation of Computer Programs in 2020
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kicking-off-hardware-happy-hour-2020" class="md-nav__link">
    <span class="md-ellipsis">
      Kicking off Hardware Happy Hour 2020
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connected-roomba-managing-state" class="md-nav__link">
    <span class="md-ellipsis">
      Connected Roomba - Managing State
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parsing-time-with-python" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing Time with Python
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#providing-context-with-mocks" class="md-nav__link">
    <span class="md-ellipsis">
      Providing Context with Mocks
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Lists
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Lists
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lists/books/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Books
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../lists/podcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Podcast
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/portfolio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Portfolio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../programming/resume/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resume
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#train-all-the-things-signaling" class="md-nav__link">
    <span class="md-ellipsis">
      Train All the Things — Signaling
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-simple-status-page" class="md-nav__link">
    <span class="md-ellipsis">
      A Simple Status Page
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#train-all-the-things-planning" class="md-nav__link">
    <span class="md-ellipsis">
      Train All the Things - Planning
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-and-apply-a-git-patch" class="md-nav__link">
    <span class="md-ellipsis">
      Create and Apply a Git Patch
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#define-zero" class="md-nav__link">
    <span class="md-ellipsis">
      (define zero(….))
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-structure-and-interpretation-of-computer-programs-in-2020" class="md-nav__link">
    <span class="md-ellipsis">
      The Structure and Interpretation of Computer Programs in 2020
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kicking-off-hardware-happy-hour-2020" class="md-nav__link">
    <span class="md-ellipsis">
      Kicking off Hardware Happy Hour 2020
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connected-roomba-managing-state" class="md-nav__link">
    <span class="md-ellipsis">
      Connected Roomba - Managing State
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#parsing-time-with-python" class="md-nav__link">
    <span class="md-ellipsis">
      Parsing Time with Python
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#providing-context-with-mocks" class="md-nav__link">
    <span class="md-ellipsis">
      Providing Context with Mocks
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="index">Index<a class="headerlink" href="#index" title="Permanent link">&para;</a></h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-03-01 00:00:00+00:00">March 1, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="train-all-the-things-signaling"><a class="toclink" href="../../2020/03/01/train-all-the-things--signaling/">Train All the Things — Signaling</a></h2>
<p>After <a href="https://burningdaylight.io/posts/train-all-the-things-planning/">figuring out</a> what I was going to use for my
project I started work with things I know. I already had some experience with Cloudflare workers building
a <a href="https://burningdaylight.io/posts/system-status-observer/">home system status</a> page, and Workers K/V makes storing and
fetching data quick and easy. I ended up with a simple endpoint that I POST to set a bit after keyword detection, and
the PyPortal retrieves that status to determine what to display:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">setCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">SIGNALS</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w">  </span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">SIGNALS</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">serviceStat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCache</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">);</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">serviceStat</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;invalid status key&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">serviceStat</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="p">});</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="nx">cacheValue</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">setCache</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="nx">cacheValue</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">((</span><span class="nx">cacheKey</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; set to &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">cacheValue</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">psk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCache</span><span class="p">(</span><span class="s2">&quot;PSK&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">presharedKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;psk&#39;</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">statusKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;service&#39;</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">statusValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">);</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">presharedKey</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">psk</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">setStatus</span><span class="p">(</span><span class="nx">statusKey</span><span class="p">,</span><span class="w"> </span><span class="nx">statusValue</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;GET&#39;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">statusKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">statusKey</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">418</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">))</span><span class="w">  </span>
<span class="p">})</span>
</code></pre></div>
<p>Nothing tricky happening above, just checking the request, and calling the appropriate function to store or fetch the
status bit. With the function deployed to my Cloudflare Worker and verified with some GET and POST calls I was ready to
move on to the <a href="https://burningdaylight.io/posts/train-all-the-things-display/">display</a>.</p>
<p>The code, docs, images etc for the project can be found <a href="https://github.com/n0mn0m/on-air">here</a> and I’ll be posting
updates as I continue along to <a href="https://hackaday.io/project/170228-on-air">HackadayIO</a> and this blog. If you have any
questions or ideas reach <a href="mailto:n0mn0m@burningdaylight.io">out</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-18 00:00:00+00:00">February 18, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="a-simple-status-page"><a class="toclink" href="../../2020/02/18/a-simple-status-page/">A Simple Status Page</a></h2>
<h5 id="i-have-a-bad-habit-of-creating-side-projects-for-my-side-projects"><a class="toclink" href="../../2020/02/18/a-simple-status-page/#i-have-a-bad-habit-of-creating-side-projects-for-my-side-projects">I have a bad habit of creating side projects for my side projects.</a></h5>
<p>A couple months ago I switched from running my blog with Pelican and Gitlab Pages to Zola and Cloudflare Workers. I
didn’t do a write up on it, but if you’re interested there’s a
good <a href="https://words.steveklabnik.com/porting-steveklabnik-com-to-workers-sites-and-zola">post by Steve Klabnik</a> to get
you started. It was a surprisingly easy switch, and gaps between writing haven’t been as difficult with the better
tools. After getting that setup I read
about <a href="https://developers.cloudflare.com/workers/reference/storage">Cloudflare Workers KV</a> , thought it sounded really
neat and started to think about what I might build.</p>
<p>On another <a href="https://burningdaylight.io/posts/train-all-the-things-planning/">project</a> I need to signal between different
systems a simple status. Naturally that lead to me building a status page. I setup a Cloudflare Worker that receives
POST from N systems, stores the date of the last POST uses that to provide a status when asked.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">setCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">LOCALSTATUS</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span><span class="w">  </span>
<span class="kd">const</span><span class="w"> </span><span class="nx">getCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">key</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">LOCALSTATUS</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span><span class="kd">function</span><span class="w"> </span><span class="nx">sleep</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span><span class="w"> </span><span class="nx">ms</span><span class="p">));</span><span class="w">  </span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">dateToStatus</span><span class="p">(</span><span class="nx">dateTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">isoDateNow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w">  </span>
<span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">dateDiff</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">isoDateNow</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">dateTime</span><span class="p">);</span><span class="w">  </span>
<span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dateDiff</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">180000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">1</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mf">0</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getStatuses</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">cacheKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">LOCALSTATUS</span><span class="p">.</span><span class="nx">list</span><span class="p">();</span><span class="w">  </span>
<span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">cacheKeys</span><span class="p">.</span><span class="nx">listcomplete</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="nx">sleep</span><span class="p">(</span><span class="mf">5</span><span class="p">)</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span><span class="w"> </span>

<span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">numKeys</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cacheKeys</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w">  </span>

<span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">statuses</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">numKeys</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">cacheKeys</span><span class="p">.</span><span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span><span class="w">  </span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">epcDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCache</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">date</span><span class="o">:</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">epcDate</span><span class="p">),</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">name</span><span class="p">};</span><span class="w">  </span>
<span class="w">  </span><span class="nx">data</span><span class="p">.</span><span class="nx">strDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">();</span><span class="w">  </span>
<span class="w">  </span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateToStatus</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">date</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="nx">data</span><span class="p">.</span><span class="nx">statusIndicator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getStatusIndicator</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="nx">statuses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span>

<span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">html</span><span class="p">(</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">statuses</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">[]));</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">body</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;text/html&#39;</span><span class="w"> </span><span class="p">},</span><span class="w">  </span>
<span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="nx">cacheDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getCache</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">);</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">cacheDate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="s1">&#39;invalid status key&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dateToStatus</span><span class="p">(</span><span class="nx">cacheDate</span><span class="p">);</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="p">});</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">updateStatus</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">isoDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w">  </span>
<span class="w">   </span><span class="k">await</span><span class="w"> </span><span class="nx">setCache</span><span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span><span class="w"> </span><span class="nx">isoDate</span><span class="p">);</span><span class="w">  </span>
<span class="w">   </span><span class="kd">var</span><span class="w"> </span><span class="nx">strDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">isoDate</span><span class="p">).</span><span class="nx">toISOString</span><span class="p">();</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">((</span><span class="nx">cacheKey</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; set at &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">strDate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot;\n&quot;</span><span class="p">),</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Response</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="mf">500</span><span class="w"> </span><span class="p">});</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">statusKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;service&#39;</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">queryType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">URL</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">searchParams</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">);</span><span class="w"> </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">method</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;POST&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">updateStatus</span><span class="p">(</span><span class="nx">statusKey</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">queryType</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;simple&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">getStatus</span><span class="p">(</span><span class="nx">statusKey</span><span class="p">);</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="nx">getStatuses</span><span class="p">();</span><span class="w">  </span>
<span class="w">  </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
<span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;fetch&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">))</span><span class="w">  </span>
<span class="p">})</span>
</code></pre></div>
<p>With that anything that can POST can "check in" with the endpoint. You can see it
working <a href="https://status.burningdaylight.io/">here</a>. I also went ahead and wrote a simple systemd service that I can drop
on to different machines I want to have report in to the endpoint.</p>
<div class="highlight"><pre><span></span><code><span class="k">[Unit]</span><span class="w">  </span>
<span class="na">Description</span><span class="o">=</span><span class="s">Regular check in</span><span class="w">  </span>
<span class="na">Wants</span><span class="o">=</span><span class="s">check-in.timer[Service]</span><span class="w">  </span>
<span class="na">Type</span><span class="o">=</span><span class="s">oneshot</span><span class="w">  </span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/bin/curl -X POST https://status.burningdaylight.io/?service=JETSON[Install]</span><span class="w">  </span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.targetAnd a timer for the service.</span>

<span class="k">[Unit]</span><span class="w">  </span>
<span class="na">Description</span><span class="o">=</span><span class="s">Run checkin every 2 minutes</span><span class="w">  </span>
<span class="na">Requires</span><span class="o">=</span><span class="s">check-in.service[Timer]</span><span class="w">  </span>
<span class="na">Unit</span><span class="o">=</span><span class="s">check-in.service</span><span class="w">  </span>
<span class="na">OnUnitInactiveSec</span><span class="o">=</span><span class="s">1m[Install]</span><span class="w">  </span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">timers.target</span>
</code></pre></div>
<p>This was a fun “Serverless/FaaS” experiment that actually let me know my ISP was having an outage one morning before
work. I’ve used other Functions as a service on other cloud platforms and while they all provide slightly different
functionality (For instance Cloudflare being a CDN and the V8 isolate setup) Cloudflare Workers has been really easy to
work with and a lot of fun to build experiments on. They even have a <a href="https://cloudflareworkers.com/">web playground</a>
that you can start with.</p>
<p>Two things I do wish were easier are interacting with K/V from Rust. This is probably partially related to how new I am
to Rust, but working with K/V from JS is super easy, while
this <a href="https://www.reddit.com/r/rust/comments/fdmzyh/serverless_rust_i_tried_it_with_cloudflare_workers/">thread</a>
documents another experience with Workers and Rust in more detail. Another mild annoyance is working with different
workers from the same machine and how API keys are handled. There are some suggestions for this, but non of them feel
ergonomic at this time. Other than that my experience with Workers and K/V has been great and I’ve already got more
ideas for future experiments.</p>
<p>The code, docs, etc for the project can be found <a href="https://github.com/n0mn0m/system-status">here</a>. If you have any
questions or ideas reach <a href="mailto:n0mn0m@burningdaylight.io">out</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-08 00:00:00+00:00">February 8, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="train-all-the-things-planning"><a class="toclink" href="../../2020/02/08/train-all-the-things---planning/">Train All the Things - Planning</a></h2>
<p>Earlier this year Hackaday announced
the <a href="https://hackaday.io/contest/169421-train-all-the-things#j-discussions-title">Train all the Things</a> contest. I
immediately knew I wanted to submit something, but figuring out what to build took me a little bit. For my side projects
I like to make something that is useful to me, or somebody I know; while also learning something new. A few days after
the contest was announced my daughter was in the basement playing outside my office/homelab when I remembered my wife
had asked me if there was a way for her to know when I was working with somebody so that they could avoid coming down in
the basement. I thought a voice driven display could be a fun solution.</p>
<h4 id="choosing-tools"><a class="toclink" href="../../2020/02/08/train-all-the-things---planning/#choosing-tools">Choosing Tools</a></h4>
<p>After deciding on the project the next thing I wanted to figure out was what new boards I would need (if any) and how I
would build my model. After doing some research I landed
on <a href="https://www.tensorflow.org/lite/microcontrollers">Tensorflow</a> as my path forward for deploying a model to a
microcontroller. Having used Tensorflow the barrier for model creation is a bit lower, but I am really curious about
Tensorflow Lite and the potential it provides. Additionally a relatively new book <a href="https://tinymlbook.com/">TinyML</a>
looks like a good resource to use along the way.</p>
<p>After settling on TF Lite the next thing was picking a board. Most of my embedded experience has been with CircuitPython
and Rust. For this project I thought it would be fun to learn something new. The Espressif ESP-EYE caught my eye as an
interesting board known to work with TF Lite. I’ve seen the ESP32 and 8266 in a lot of other projects, so learning the
ESP toolchain seems valuable. Additionally a lot of the Espressif ecosystem seems to be built around FreeRTOS which
provides a whole other avenue of learning and hacking.</p>
<p>Finally I will need a way to let somebody know when the model has picked up voice activity, to signal that I’m currently
busy in the lab. The ESP32 has a WiFi chip providing the ability to send and receive signals via TCP if we want. The
ESP-EYE has that built in, and I happend to have a PyPortal (with an ESP32) that could make a great display checking for
a status using WiFi too. To signal from one to the other I decided to have some fun and use Cloudflare Workers K/V to
set a bit from the ESP-EYE that would be read by the PyPortal at a given time interval to set the display.</p>
<p>Putting it all together the initial idea looks something like this:</p>
<p><img alt="" src="../../../img/blog/07Ex2dh4NkgBHiLFg.jpg" /></p>
<p>Which allows me to have a small board in my homelab listening and the display above the stairwell where somebody can get
a status update before they ever come down.</p>
<p>The code, docs, images etc for the project can be found <a href="https://github.com/n0mn0m/on-air">here</a> and I’ll be posting
updates as I continue along to <a href="https://hackaday.io/project/170228-on-air">HackadayIO</a> and this blog. If you have any
questions or ideas reach <a href="mailto:n0mn0m@burningdaylight.io">out</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-04 00:00:00+00:00">February 4, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="create-and-apply-a-git-patch"><a class="toclink" href="../../2020/02/04/create-and-apply-a-git-patch/">Create and Apply a Git Patch</a></h2>
<p>I’ve been using Source Hut as my primary host for source control and builds for a few months. I really enjoy it, but one
of the main things I had to learn up front was how to apply a patch in git. Unlike Github and many other git host Source
Hut makes use of the git patch work flow instead of PRs. At first I found this to be a bit frustrating, but I’ve
actually come to see the value in the email and patch workflow that is different from the IM and PR work flow that many
of us are used to. Hopefully this helps somebody else that is learning to use patches in the future.</p>
<p>Build your feature or modify your code on a separate branch:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>-b<span class="w"> </span>...<span class="w">  </span>
git<span class="w"> </span>add<span class="w"> </span>...<span class="w">  </span>
git<span class="w"> </span>commit<span class="w">  </span>
git<span class="w"> </span>push
</code></pre></div>
<p>Prepare a patchset:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>format-patch<span class="w"> </span>main
</code></pre></div>
<p>Alternative for a patch directory</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>format-patch<span class="w"> </span>main<span class="w"> </span>-o<span class="w"> </span>patches
</code></pre></div>
<p>Or login and find the link to download the patch:</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-O<span class="w"> </span>https://github.com/n0mn0m/circuitroomba/commit/ae635ce6533e33ff5277a0428a59c736a98649d6.patchls<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;.patch&quot;</span><span class="w">  </span>
</code></pre></div>
<p>Switch back to main:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>checkout<span class="w"> </span>main
</code></pre></div>
<p>Check the patchset changes</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>apply<span class="w"> </span>--stat<span class="w"> </span>ae635ce6533e33ff5277a0428a59c736a98649d6.patch
</code></pre></div>
<p>Check for errors</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>apply<span class="w"> </span>--check<span class="w"> </span>ae635ce6533e33ff5277a0428a59c736a98649d6.patch
</code></pre></div>
<p>Assuming the above command doesn’t generate any errors you are ready to apply a clean patch. The git amcommand below
includes the --signoff flag for others to view.</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>am<span class="w"> </span>--signoff<span class="w"> </span>&lt;<span class="w"> </span>ae635ce6533e33ff5277a0428a59c736a98649d6.patch
</code></pre></div>
<p>And with that the patch has been applied to your main branch. Run your test again for sanity sake and push main.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-03 00:00:00+00:00">February 3, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="define-zero"><a class="toclink" href="../../2020/02/03/define-zero/">(define zero(….))</a></h2>
<p>A couple weeks ago I had the opportunity to attend
the <a href="https://mitpress.mit.edu/sites/default/files/sicp/index.html">SICP</a> course taught
by <a href="https://www.dabeaz.com/sicp.html">David Beazley</a>. I’ve written a short summary of my
experience <a href="https://burningdaylight.io/posts/sicp-beazley-review/">here</a> (tldr; take the course if you get the chance).
While the course as a whole was challenging and an interesting a couple of the exercises stood out to me, and I wanted
to take a moment to share them here.</p>
<h4 id="true"><a class="toclink" href="../../2020/02/03/define-zero/#true">TRUE</a></h4>
<p>At a deep level our computer is operating super fast on a state of ON/OFF with gates that define logic. Because of this
it's an area of interest for me in how we express similar logic in our languages and the statement/operator capabilities
we can build from that. Towards the beginning of day two we kicked things off by defining our own boolean logic in
Racket. Our first step? Defining TRUE and FALSE.</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">TRUE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">  </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">FALSE</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">y</span><span class="p">)(</span><span class="k">define</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="p">(</span><span class="n">TRUE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">t</span><span class="w">  </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">FALSE</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">fTake</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">minute</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">reread</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">block</span><span class="o">,</span><span class="w"> </span><span class="n">because</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nb">first</span><span class="w"> </span><span class="k">time</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">threw</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">loop.</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">just</span><span class="w"> </span><span class="n">passed</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="n">arguments</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">got</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">FALSE.</span><span class="w"> </span><span class="n">In</span><span class="w"> </span><span class="n">Racket</span><span class="o">,</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="k">this</span><span class="w"> </span><span class="n">scenario</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">defined</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">behavior</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">basic</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="n">operators.</span><span class="w"> </span><span class="n">The</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">challenge</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">were</span><span class="w"> </span><span class="n">provided</span><span class="w"> </span><span class="n">was</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">implement</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="n">boolean</span><span class="w"> </span><span class="n">logic</span><span class="w"> </span><span class="n">operators.</span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">NOT</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="n">TRUE</span><span class="p">))(</span><span class="n">NOT</span><span class="w"> </span><span class="n">TRUE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">f</span><span class="w">  </span>
<span class="p">(</span><span class="n">NOT</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">t</span><span class="w">  </span>

<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">AND</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">  </span>
<span class="p">(</span><span class="n">AND</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">t</span><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">OR</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">))</span><span class="w">  </span>
<span class="p">(</span><span class="n">OR</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">f</span><span class="w">  </span>
<span class="p">(</span><span class="n">OR</span><span class="w"> </span><span class="n">TRUE</span><span class="w"> </span><span class="n">FALSE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">t</span><span class="w">  </span>
<span class="p">(</span><span class="n">OR</span><span class="w"> </span><span class="n">FALSE</span><span class="w"> </span><span class="n">TRUE</span><span class="p">)</span><span class="w">  </span>
<span class="o">&#39;</span><span class="ss">t*</span><span class="c1">;;</span>
</code></pre></div>
<p>Hint: x is not just TRUE/FLASE above. It is a procedure, it takes two arguments. And we now have our own set of truth
tables.</p>
<h4 id="defining-zero"><a class="toclink" href="../../2020/02/03/define-zero/#defining-zero">Defining Zero</a></h4>
<p>Before working on boolean logic we had been discussing the substitution model of evaluation and what you could express
with it. After our truth searching exercise it seemed like looking at how numbers could work might be fun.</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">zero</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">)))</span><span class="w">  </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="p">)))))</span><span class="w">  </span>
<span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="n">three</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="n">x</span><span class="p">))))))</span>
</code></pre></div>
<p>Defining numbers as symbols for the application of a function N times then let us implement addition:</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="n">plus</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">  </span>
<span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">a</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">b</span><span class="w"> </span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">))))</span><span class="w">  </span>
<span class="w"> </span><span class="p">)(</span><span class="k">define</span><span class="w"> </span><span class="n">five</span><span class="w"> </span><span class="p">(</span><span class="n">plus</span><span class="w"> </span><span class="n">two</span><span class="w"> </span><span class="n">three</span><span class="p">))</span>
</code></pre></div>
<p>Or to make it concrete</p>
<div class="highlight"><pre><span></span><code>(define (inc x) (+ x 1))((five inc) 0)  
&#39;5
</code></pre></div>
<p>Numbers are weird and amazing. Ever since I realized that anything we can express in a program (that I’m writing in
letters and symbols) can be boiled down to a series of 0s and 1s that were ultimately symbols that could be swapped out
I’ve been captivated by the question of what numbers are. We did other interesting and exercises (mutation, building an
interpreter, a register machine VM, and generic types), but something about the above left me considering the nature of
logic and programming. It’s easy to get lost in the day to day problem solving, but when we get the chance to step back
and look at the strangeness of what we are interacting with it can be a lot of fun. Here’s one last thought to have some
fun with:</p>
<p>Always returns false, except for zero, because zero says don't do the function so we get back true</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="k">define</span><span class="w"> </span><span class="p">(</span><span class="nb">zero?</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">((</span><span class="n">n</span><span class="w"> </span><span class="p">(</span><span class="k">lambda</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="no">#f</span><span class="p">))</span><span class="w"> </span><span class="no">#t</span><span class="p">))</span>
</code></pre></div>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-02 00:00:00+00:00">February 2, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="the-structure-and-interpretation-of-computer-programs-in-2020"><a class="toclink" href="../../2020/02/02/the-structure-and-interpretation-of-computer-programs-in-2020/">The Structure and Interpretation of Computer Programs in 2020</a></h2>
<p>Last week I had the opportunity to attend a course by <a href="https://www.dabeaz.com/sicp.html">David Beazley</a>
on <a href="https://mitpress.mit.edu/sites/default/files/sicp/index.html">SICP</a> (The Structure and Interpretation of Computer
Programs). SICP is a book that was first published in 1985 and has grown to have a bit of a reputation in various
circles of software engineering. The book itself explores many areas of computer science with a language called Scheme (
a lisp). For the course we made use of Racket and Python to explore those same concepts working through the book with an
eye to it’s impact on modern language and design.</p>
<p>A quick note. This course was unlike any other I have been in so far. David is really good at giving learners the time
and space to think as he lays out really dense material and like a tour guide provides interesting insights about the
landscape. Another great part of the class was the size and how Dave gives people time to engage each other. Each
morning we shared ideas, experiences and other stories over breakfast before throwing ourselves into the material
breaking for lunch to contemplate what we had just built or discovered rounded off with an afternoon coffee. Overall
this was a fantastic educational experience and I hope I get the opportunity to repeat it with some of Dave’s other
courses in the future.</p>
<p>Throughout the week we engaged with various problems in the book such as evaluation models, abstraction, symbolic data
and more. Each time we approached a problem we were encouraged to think as language designers and implementors rather
than language users. In doing so we put ourselves in a different state approaching problem solving by extending the
features of our language. This led us to implementing object hierarchy and evaluation models, dispatching state handling
and creating custom interpreters with domain specific features to solve problems.</p>
<p>One part of SICP book that stood out was the use of ‘wishful thinking’ as our programming model. We would look at a
problem (for instance a constraints issue for assigning tenants to floors) and ask ourselves what a procedure or feature
would look like for accepting the data and solving said problem. We would then implement this procedure and even mock
calling other procedures that did not exist yet to model what we felt like an optimal interface might look like. From
there we would build down implementing each new layer with wishful thinking. This came in contrast to a lot of my day to
day experience approaching problems bottom up implementing low level details and data processing logic on our way to an
isolated solution. In some ways it felt similar to TDD if you mock out all the functionality you don’t have yet, but
again with the top down mindset of I want the langauge to do X for me.</p>
<p>Many other topics are covered throughout SICP. The book itself is very top down starting with the language and going all
the way down to implementing a VM/register machine by the end of the book. Over time I may write some more about those
topics. All in all the course was incredibly interesting. The conversations around lunch about the nature and philosophy
of computing were a lot of fun and spawned by the material being covered as well as the various backgrounds we all had
in our day to day work. You don’t leave the course with a new package or framework in your toolbelt. Instead you’ve
examined of of the underlying fundamentals of languages, computing and software. This equips you with new models for
thinking that will hopefully impact any future computing that you take part in. While the material is dense I think
anybody that truly enjoys engaging with our craft would benefit from engaging with the SICP material in this setting.</p>
<p>If anybody has questions about the course I’d be more than happy to talk about the material. For those of you who don’t
know <a href="https://www.youtube.com/user/dabeazllc/videos">David Beazley</a> I would encourage you to visit his site or search
his name on YouTube as he has a lot of interesting material that encourages the learner to engage the material.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-02-01 00:00:00+00:00">February 1, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="kicking-off-hardware-happy-hour-2020"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/">Kicking off Hardware Happy Hour 2020</a></h2>
<p>Last year we kicked off the first Hardware Happy Hour in Louisville Kentucky, USA. We had a lot of fun sharing our
projects with each other and hearing about all the things being built in our own back yard. If you’re building something
you should try looking for an <a href="https://hardwarehappyhour.com/events/">event</a> in
your <a href="https://www.google.com/search?client=firefox-b-1-d&amp;q=hardware+happy+hour">area</a> as more and more are popping up
around the world.</p>
<h4 id="circuit-playground-workshop"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/#circuit-playground-workshop">Circuit Playground Workshop</a></h4>
<p>This year we wanted to start things off by inviting everybody to build and learn together with
the <a href="https://www.adafruit.com/product/3333">Circuit Playground Express</a>. On January 29th we got
together <a href="https://flic.kr/s/aHsmL8818Z">15 makers and hackers</a> to have some fun with Arduino and Circuit Python making
LEDs blink and speakers buzz. To kick things off Auystn introduced the group to the Arduino IDE, getting it to recognize
your board setup, and receiving feedback via the serial console. As with any workshop we had plenty of fun figuring out
why this and that didn’t work on whatever OS, but in many ways I think that was exposure for those new to working with
the boards and tools that unexpected behavior may occur, but we can find a solution.</p>
<p>Once everybody had a board up and working <a href="https://flic.kr/p/2inNG6V">Austyn</a> spent some time getting everybody
comfortable with the Arduino syntax and constructs. That turned into showing how to make
some <a href="https://github.com/h3-louisville/HardwareLou_CircuitPlayground/blob/main/cricket/lightsensor_cricket.ino">noise</a>
followed by a quick on/off switch demo. With a couple more code demos and showing off the Arduino code library we
decided to switch gears and look at Circuit Python before having some general open make time.</p>
<p>With Circuit Python we had the same demos with a different approach. Instead of using an IDE and editor we showed how
you could put the board into bootloader mode and drag and drop the UF2 and code files directly on the board for loading.
Along with that we demo’d the ability to use REPL driven development on the boards for quick prototyping and feedback.</p>
<p>Armed with Arduino and Circuit Python we decided it was time for us to step back and let people hack. Some had fun with
accelerometer libraries while others scanned colors and lit up LEDs. By the end of the night I was rick rolled by a
Circuit Playground.</p>
<p><img alt="" src="../../../img/blog/0XTsz57C6GeEzfHAq.jpg" /></p>
<p><img alt="" src="../../../img/blog/08ByegkU1kkUpsb18.jpg" /></p>
<p><img alt="" src="../../../img/blog/0n87_-bSCN0DDeIuU.jpg" /></p>
<p>More photos from the event <a href="https://flic.kr/ps/3R1NR2">here</a></p>
<h4 id="louisville-hardware-happy-hour-2020"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/#louisville-hardware-happy-hour-2020">Louisville Hardware Happy Hour 2020</a></h4>
<p>As 2020 continues we have 3 more H3 events planned in Louisville. Similar to our 2019 event we are planning to have a Q2
and Q4 social. If you’re in the area we would love to see or hear about your project over some food and drink
at <a href="https://www.greatfloodbrewing.com/">Great Flood</a>. In Q3 we are hoping to acquire some scopes to run a scope tutorial
making use of the Circuit Playground boards and teaching attendees how they can see their programs in a new way.</p>
<h4 id="sponsors"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/#sponsors">Sponsors</a></h4>
<p>We (Austyn, Brad and I) want to give a huge shout out and thank you to
the <a href="https://civicdataalliance.org/">Louisville Civic Data Alliance</a>. Without their support and sponsorship we would not
be able to provide boards for all of the attendees to use. They have helped us kickstart a set of hardware that we can
use to drive future workshops and education experiences. Thank you for providing us with
the <a href="https://www.adafruit.com/product/3399">Code.org Circuit Playground Express Educators’ Pack</a>.</p>
<p>Thank you to <a href="https://www.lvl1.org/about/">LVL1</a> for hosting. LVL1 is an amazing local resource in the area. If you
haven’t checked it out you should definitely try to make it to one of
the <a href="https://www.lvl1.org/events/">Open Meeting and Making</a> events on Tuesday nights.</p>
<p>Thanks to <a href="https://www.tindie.com/">Tindie</a> for some awesome stickers and swag.</p>
<p>And thank you to the various <a href="https://code.org/about/donors">code.org</a> donors who made
the <a href="https://www.adafruit.com/product/3399">Adafruit Educators Pack</a> possible for us to purchase and use.</p>
<h4 id="sponsorship-assistance"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/#sponsorship-assistance">Sponsorship Assistance</a></h4>
<p>As I previously mentioned we are looking to run a scopes workshop this fall. If you or an organization you know is
interested in sponsoring this event we are looking for help in acquiring digital scopes to provide attendees with. If
you are interested in helping please reach <a href="mailto:contact@h3lou.org">out</a>.</p>
<h5 id="where-to-follow"><a class="toclink" href="../../2020/02/01/kicking-off-hardware-happy-hour-2020/#where-to-follow">Where to follow</a></h5>
<p>To keep up with future H3 Louisville events we have a group setup
on <a href="https://gettogether.community/hardware-happy-hour/">gettogether.community</a> and we are active in the #hardware
channel for <a href="https://louisville.slack.com/">Louisville Slack</a>.</p>
<p>Events will also be published to the <a href="https://louisvilletech.org/">Louisville Tech</a>
and <a href="https://calendar.google.com/calendar?cid=YW51ajMyMmxlY3RzdDRqN2Zsb2xwN3J2dmNAZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ">H3 Louisville</a>
calendars.</p>
<p>You can find our code and presentations on <a href="https://github.com/Hardware-Happy-Hour-Louisville">Github</a>.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-24 00:00:00+00:00">January 24, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="connected-roomba-managing-state"><a class="toclink" href="../../2020/01/24/connected-roomba---managing-state/">Connected Roomba - Managing State</a></h2>
<p>Last year I started work and completed the first prototype for managing a roomba via sms and radio. Overall the
prototype was a successful, but over time highly unreliable in the face of failure. Most of this came down to state
management for the API endpoint and the Roomba OI (Open Interface) code running on the Feather. This week I had the
opportunity to sit down and fix some of that.</p>
<p>The latest version of the project can be found <a href="https://github.com/n0mn0m/bot_commander">here</a>.</p>
<h4 id="roomba"><a class="toclink" href="../../2020/01/24/connected-roomba---managing-state/#roomba">Roomba</a></h4>
<p>In previous version of the application that ran on the Feather listening for messages over radio I had managed the
application state in this class:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenInterface</span><span class="p">:</span>  
 <span class="k">def</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">txpin</span><span class="p">,</span> <span class="n">rxpin</span><span class="p">,</span> <span class="n">brcpin</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">):</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">board</span> <span class="o">=</span> <span class="n">busio</span><span class="o">.</span><span class="n">UART</span><span class="p">(</span><span class="n">txpin</span><span class="p">,</span> <span class="n">rxpin</span><span class="p">,</span> <span class="n">baudrate</span><span class="o">=</span><span class="n">baudrate</span><span class="p">)</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">txpin</span> <span class="o">=</span> <span class="n">txpin</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">rxpin</span> <span class="o">=</span> <span class="n">rxpin</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">brcpin</span> <span class="o">=</span> <span class="n">brcpin</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">brcpin</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">digitalio</span><span class="o">.</span><span class="n">Direction</span><span class="o">.</span><span class="n">OUTPUT</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudrate</span>  
 <span class="bp">self</span><span class="o">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="kc">True</span>
</code></pre></div>
<p>I had done this so that I couldn’t send the Roomba signals that were invalid for a given state based on the Open
Interface documentation. The <a href="https://github.com/n0mn0m/circuitroomba">circuitroomba</a> project were I originally
implemented this actually did a lot more state management. Overall maybe this would be helpful during application
development, but I found it made code on the board unreliable due to the size of the class object in memory and other
work going on causing the board to eventually crash over an extended period of time.</p>
<p>The more I thought about this I also realized I had caused an even larger issue. The Roomba itself manages state
internally. It has all of the logic laid out in the OI document impelmented internally keeping things “safe” and
tracking if a given signal is valid or not. By adding my own state management layer on top of this I opened the door for
all kinds of trouble. First if the internal Roomba logic differed from the OI documentation, or I implemented the OI
logic incorrectly I would be sending the application developer down all kinds of paths trying to figure out why state
transistion and command signals were not exhibiting the expected behavior. Why setup 2 FSMs when one will do, and only
one ends up being the true dispatch? If we did this at the sms API layer we could have 3, all with the potential for
bugs, unexpected behavior, logic mismatches, timing issues etc. It’s a combinatorial explosion of state management
issues.</p>
<p>So stepping back, considering the separation of concerns I determined all the board needed to do was listen for a given
signal flag and pass that on to the Roomba. From there the Roomba can determine if the signal should be acted on based
on it’s internal state.</p>
<p>The new implementation discards the class object and instead just uses a super loop and signal functions.</p>
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>  
 <span class="k">try</span><span class="p">:</span>  
 <span class="n">packet</span> <span class="o">=</span> <span class="n">rfm9x</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">packet</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
 <span class="n">packettxt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>  
 <span class="nb">print</span><span class="p">(</span><span class="n">packettxt</span><span class="p">)</span> <span class="k">if</span> <span class="n">packettxt</span> <span class="o">==</span> <span class="s2">&quot;0&quot;</span><span class="p">:</span>  
 <span class="n">commandreceived</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>  
 <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>  
 <span class="n">stop</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>  
 <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">False</span>  
 <span class="k">elif</span> <span class="n">packettxt</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>  
 <span class="n">commandreceived</span><span class="p">(</span><span class="n">led</span><span class="p">)</span>  
 <span class="n">wakeup</span><span class="p">(</span><span class="n">brc</span><span class="p">)</span>  
 <span class="n">start</span><span class="p">(</span><span class="n">bot</span><span class="p">)</span>  
 <span class="n">led</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="kc">True</span>  
 <span class="k">else</span><span class="p">:</span>  
 <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Unknown packet: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">packettxt</span><span class="p">))</span>  
 <span class="k">except</span><span class="p">:</span>  
 <span class="k">pass</span>
</code></pre></div>
<p>Additionally from time to time signals can have issues that previously caused hanging in the application. Now the logic
inside the super loop is wrapped in a try/except to prevent corrupt date from completely crashing the application.
Instead failures are ignored and we keep listening for the next signal. While this isn't always a viable solution in the
case of signaling the Roomba the stakes are low and this is something I'm comfortable with.</p>
<h4 id="pi-zero"><a class="toclink" href="../../2020/01/24/connected-roomba---managing-state/#pi-zero">Pi Zero</a></h4>
<p>After fixing up the Feather board code I moved onto the Pi applications. Previously I had setup a Flask application to
act as the SMS webhook for Twilio. This worked pretty well and was consistent over time, but there was the occasional
hang running on the Zero that led me to look into managing the Python and Ngrok application with systemd. Converting
from crontab was fairly easy. I created a few *.service files and placed them in /etc/systemd/system.</p>
<div class="highlight"><pre><span></span><code><span class="na">[Unit]  </span>
<span class="na">Description</span><span class="o">=</span><span class="s">sms listener  </span>
<span class="na">After</span><span class="o">=</span><span class="s">ngrok.service[Service]  </span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple  </span>
<span class="na">User</span><span class="o">=</span><span class="s">pi  </span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/home/pi  </span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/home/pi/.virtualenvs/lora-pi/bin/python /home/pi/projects/roombasupervisor/smslistener.py  </span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure[Install]  </span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>
<p>Once the files were created I ran the following commands:</p>
<div class="highlight"><pre><span></span><code>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>smslistener.service<span class="w">  </span>
systemctl<span class="w"> </span>start<span class="w"> </span>smslistener.service
</code></pre></div>
<p>And now all of the required applications (ngrok, sms listener, button listener) are managed by systemd. This controls
their startup better than the previous crontab setup and has the added benefit of restarting the service if it fails
our.</p>
<h4 id="wrapping-up"><a class="toclink" href="../../2020/01/24/connected-roomba---managing-state/#wrapping-up">Wrapping up</a></h4>
<p>By observing and understanding the ways in which the prototyped system failed I was able to identify areas where
behavior and functionality could be simplified resulting in an overall more reliable system. If you have any other tips
to share <a href="mailto:n0mn0m@burningdaylight.io">reach out</a> and good luck hacking.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-23 00:00:00+00:00">January 23, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              3 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="parsing-time-with-python"><a class="toclink" href="../../2020/01/23/parsing-time-with-python/">Parsing Time with Python</a></h2>
<p>I recently had the need to measure time and performance on an application that interacted with a lot of on disk files.
Most of the time when talking about timing and measurement in Python we see the use of timeitand various built in timing
techniques. For this work I wanted a little more information about how the application was interacting with the system,
and what the performance looked like from outside the application. Getting a rough view of this is pretty easy on a nix
using <a href="http://man7.org/linux/man-pages/man1/time.1.html">/usr/bin/time</a>.</p>
<h4 id="parsing-time"><a class="toclink" href="../../2020/01/23/parsing-time-with-python/#parsing-time">Parsing Time</a></h4>
<p>To make use of time you simply call it with your application as an argument. You can find the time args with man time,
but on useful one is the -v flag for more system information in the output, and an --output file path. Doing this you
get a fair amount of page, time and system information in your output packaged up in a file that you can parse. In my
script I'm also including some information in the file name so I can know what source file my application was parsing
relating to that time information.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

<span class="nv">SRCDIRPATH</span><span class="o">=</span>/data<span class="w">  </span>
<span class="nv">RESULTS</span><span class="o">=</span>/profilefor<span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$SRDDIRFILES</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w">  </span>
<span class="w"> </span><span class="nv">filename</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span>--<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="k">)</span><span class="w">  </span>
<span class="w"> </span><span class="nv">filebase</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">filename</span><span class="p">%.*</span><span class="si">}</span><span class="s2">&quot;</span><span class="w">  </span>
<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nv">$filebase</span><span class="w">  </span>
<span class="w"> </span>/usr/bin/time<span class="w"> </span>-v<span class="w"> </span>--output<span class="o">=</span><span class="nv">$PROFILERESULTSDIR$filebase</span>.txt<span class="w"> </span>cmd<span class="w"> </span>args<span class="w">  </span>
<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;done&quot;</span><span class="w">  </span>
donels<span class="w"> </span>-1sh<span class="w"> </span><span class="nv">$SRCDIRPATH</span><span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>profileddirectory.size
</code></pre></div>
<p>Once the application has ran you can see the output of time in your file, but you will also probably notice that it’s
just a text blob not ready for aggregation. Overall parsing time is relatively straight forward with one gotcha. I use
the below to translate the blob into rows and columns:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Union</span>  

<span class="k">def</span><span class="w"> </span><span class="nf">formattimeprofileoutput</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fobject</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>  
<span class="w"> </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd"> Takes a directory of files containing the output of /usr/bin/time  </span>
<span class="sd"> and transforms the time blob data to a series of rows and columns.  </span>
<span class="sd"> &quot;&quot;&quot;</span>  
 <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fobject</span><span class="p">)</span>  
 <span class="n">timemetrics</span> <span class="o">=</span> <span class="p">[</span><span class="n">fobject</span><span class="p">]</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tfile</span><span class="p">:</span>  
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">tfile</span><span class="p">:</span>  
  <span class="k">if</span> <span class="s2">&quot;Elapsed&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>  
   <span class="n">cleanline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>  
   <span class="n">metric</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">cleanline</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>  
   <span class="n">timemetrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  
  <span class="k">else</span><span class="p">:</span>  
   <span class="c1"># Handling the special case of the Elapsed time  </span>
   <span class="c1"># format using : in the time formatting.  </span>
   <span class="n">cleanline</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>  
   <span class="n">metric</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">cleanline</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>  
   <span class="c1"># we now have something like val = 43.45  </span>
   <span class="c1"># metric = Elapsed (Wall Clock) time (H:MM:SS or M:ss) 1  </span>
   <span class="c1"># partition again on metric, then combine back our time.  </span>
   <span class="n">metric</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>  
   <span class="c1"># put time back into metrics  </span>
   <span class="n">value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">min</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">secs</span><span class="si">}</span><span class="s2">&quot;</span>  
   <span class="n">timemetrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>  
   <span class="c1"># setup tool second metric for easier evaluation of  </span>
   <span class="c1"># time metrics  </span>
   <span class="n">minutes</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>  
   <span class="n">seconds</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>  
   <span class="n">seconds</span> <span class="o">+=</span> <span class="n">minutes</span>  
   <span class="n">timemetrics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>  
 <span class="k">return</span> <span class="n">timemetrics</span>
</code></pre></div>
<p>Notice the one edge case in Elapsed (wall clock) time...). All other rows end with \n and seperate the metric name from
the value with :. Elapsed wall clock time however throws in a couple extra colons for fun. Overall not a big deal, but a
little gotcha waiting in the details when going from a string to another object/format.</p>
<p>Using the script above you end up with a collection of rows and columns that you can then use to find out how your
application performed for that run instance.</p>
<p>A quick bonus script, since my application was reading in and writing out new files I wanted to include the size of the
input files so I could begin to understand the impact of the input file size on the applications time metrics.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">osdef</span> <span class="n">formatsizeoutput</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fobject</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>  
 <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fpath</span><span class="p">,</span> <span class="n">fobject</span><span class="p">)</span>  
 <span class="n">sizemetrics</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">sfile</span><span class="p">:</span>  
 <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sfile</span><span class="p">:</span>  
 <span class="n">metric</span><span class="p">,</span> <span class="n">sep</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>  
 <span class="n">sizemetrics</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">filename</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>  
 <span class="k">return</span> <span class="n">sizemetrics</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
</code></pre></div>
<p>With this and the above time parsing we have the input file size, name, application command, page and time information.
More than enough to begin looking at what our application is doing from the outside.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2020-01-23 00:00:00+00:00">January 23, 2020</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="providing-context-with-mocks"><a class="toclink" href="../../2020/01/23/providing-context-with-mocks/">Providing Context with Mocks</a></h2>
<p>Day to day I spend a lot of time interacting with database systems. While this is super useful it can also create issues
with testing that have been covered many many times in many other articles.</p>
<p>In some languages isolating database interactions comes from dependency injection and swapping out the interface while
testing. I’ve seen this approach when working with C# for instance, but in Python I typically see code bases mocking out
these interface points rather than passing in interfaces to functions and classes.</p>
<h4 id="mocking-context"><a class="toclink" href="../../2020/01/23/providing-context-with-mocks/#mocking-context">Mocking context</a></h4>
<p>One of my favorite constructs in Python is
the <a href="https://docs.python.org/3/reference/datamodel.html#context-managers">context manager</a>. These are incredibly useful
objects for defining what the creation and destruction of different interfaces should do viaenter and exit. (Append a
for async context managers)</p>
<p>While useful they can be a bit tricky for mocking out in your test, and recently when I started doing just that I
couldn’t find any good examples for accomplishing this. Below I’ve provided an example of mocking out a context manager
in your test, showing when you are interacting with different parts of your mock and the mocked context manager API.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">updateentity</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>  
 <span class="k">with</span> <span class="n">pyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">cnxnstr</span><span class="p">,</span> <span class="n">autocommit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> <span class="k">as</span> <span class="n">cnxn</span><span class="p">:</span>  
  <span class="k">with</span> <span class="n">cnxn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span> <span class="k">as</span> <span class="n">crsr</span><span class="p">:</span>  
   <span class="n">crsr</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>  
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">unittest</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestCase</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest.mock</span><span class="w"> </span><span class="kn">import</span> <span class="n">patchclass</span> <span class="n">InterfaceTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>  
 <span class="nd">@patch</span><span class="p">(</span><span class="s2">&quot;mod.pyodbc.connect&quot;</span><span class="p">)</span>  
 <span class="k">def</span><span class="w"> </span><span class="nf">testupdateentity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mockcnxn</span><span class="p">):</span>  
 <span class="c1"># result of pyodbc.connect  </span>
 <span class="n">mockcnxncontextmanager</span> <span class="o">=</span> <span class="n">mockcnxn</span><span class="o">.</span><span class="n">returnvalue</span>  
 <span class="c1"># object assigned to in with ... as con  </span>
 <span class="n">mockcm</span> <span class="o">=</span> <span class="n">mockcnxncontextmanager</span><span class="o">.</span><span class="n">enter</span><span class="o">.</span><span class="n">returnvalue</span>  
 <span class="c1"># result of with ... as crsr, note the extra enter.returnvalue  </span>
 <span class="c1"># from the context manager  </span>
 <span class="n">mockcrsr</span> <span class="o">=</span> <span class="n">mockcm</span><span class="o">.</span><span class="n">cursor</span><span class="o">.</span><span class="n">returnvalue</span><span class="o">.</span><span class="n">enter</span><span class="o">.</span><span class="n">returnvalue</span>  
 <span class="n">mockcrsr</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">returnvalue</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,)</span>  
</code></pre></div>
<p>Or if you want to test a sideeffect:</p>
<div class="highlight"><pre><span></span><code><span class="n">mockcrsr</span><span class="o">.</span><span class="n">fetchone</span><span class="o">.</span><span class="n">sideeffect</span><span class="o">**</span> 
<span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">assertEqueal</span><span class="p">(</span><span class="o">....</span><span class="p">)</span>
</code></pre></div>
<p>Good luck mocking, context is what you make it.</p>
<h4 id="additional-reading"><a class="toclink" href="../../2020/01/23/providing-context-with-mocks/#additional-reading">Additional Reading</a></h4>
<p>If you want to know more about context managers in Python checkout:</p>
<ul>
<li><a href="https://www.python.org/dev/peps/pep-0343/">PEP 343</a></li>
<li><a href="https://docs.python.org/3/library/contextlib.html">contextlib</a></li>
</ul>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <a class="md-pagination__link" href="../../">1</a> <a class="md-pagination__link" href="../2/">2</a> <a class="md-pagination__link" href="../3/">3</a> <span class="md-pagination__current">4</span> <a class="md-pagination__link" href="../5/">5</a> <a class="md-pagination__link" href="../6/">6</a> <a class="md-pagination__link" href="../7/">7</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="/feed_rss_updated.xml" target="_blank" rel="noopener" title="RSS Feed" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.path", "icons"], "search": "../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>