
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Alexander Hagerman">
      
      
        <link rel="canonical" href="https://burningdaylight.io/blog/2018/10/27/dealing-with-null-in-pyspark-transformations/">
      
      
        <link rel="prev" href="../../25/derbypy-intro-to-pyspark/">
      
      
        <link rel="next" href="../../../12/22/docker-airflow/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS feed" href="../../../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="RSS feed of updated content" href="../../../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../../../icons/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Dealing with NULL in PySpark transformations - burningdaylight</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../css/styles.css">
    
      <link rel="stylesheet" href="../../../../../css/portfolio.css">
    
      <link rel="stylesheet" href="../../../../../css/resume.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="hsl(195,-80%,-42%)" data-md-color-accent="hsl(284,-22%,-36%)">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#otherwise" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://burningdaylight.io" title="burningdaylight" class="md-header__button md-logo" aria-label="burningdaylight" data-md-component="logo">
      
  <img src="../../../../../icons/favicon.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            burningdaylight
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Dealing with NULL in PySpark transformations
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="hsl(195,-80%,-42%)" data-md-color-accent="hsl(284,-22%,-36%)"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="hsl(284,-22%,-36%)" data-md-color-accent="hsl(195,-80%,-42%)"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://burningdaylight.io" title="burningdaylight" class="md-nav__button md-logo" aria-label="burningdaylight" data-md-component="logo">
      
  <img src="../../../../../icons/favicon.png" alt="logo">

    </a>
    burningdaylight
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../me/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Me
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      <a href="../../../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Index
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2025/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2025
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2022/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2022
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2021/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2021
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2020/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2020
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2019/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2019
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="../../../../archive/2018/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2018
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Lists
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Lists
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../lists/books/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Books
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../lists/podcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Podcast
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Programming
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../programming/portfolio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Portfolio
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../programming/resume/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Resume
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#otherwise" class="md-nav__link">
    <span class="md-ellipsis">
      Otherwise()
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#into-the-jvm" class="md-nav__link">
    <span class="md-ellipsis">
      Into the JVM
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#wrapping-up" class="md-nav__link">
    <span class="md-ellipsis">
      Wrapping Up
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content md-content--post" data-md-component="content">
    <div class="md-sidebar md-sidebar--post" data-md-component="sidebar" data-md-type="navigation">
      <div class="md-sidebar__scrollwrap">
        <div class="md-sidebar__inner md-post">
          <nav class="md-nav md-nav--primary">
            <div class="md-post__back">
              <div class="md-nav__title md-nav__container">
                <a href="../../../../" class="md-nav__link">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
                  <span class="md-ellipsis">
                    Back to index
                  </span>
                </a>
              </div>
            </div>
            
            <ul class="md-post__meta md-nav__list">
              <li class="md-nav__item md-nav__item--section">
                <div class="md-post__title">
                  <span class="md-ellipsis">
                    Metadata
                  </span>
                </div>
                <nav class="md-nav">
                  <ul class="md-nav__list">
                    <li class="md-nav__item">
                      <div class="md-nav__link">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg>
                        <time datetime="2018-10-27 00:00:00+00:00" class="md-ellipsis">October 27, 2018</time>
                      </div>
                    </li>
                    
                    
                    
                      
                      <li class="md-nav__item">
                        <div class="md-nav__link">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg>
                          <span class="md-ellipsis">
                            
                              6 min read
                            
                          </span>
                        </div>
                      </li>
                    
                  </ul>
                </nav>
              </li>
            </ul>
          </nav>
          
        </div>
      </div>
    </div>
    <article class="md-content__inner md-typeset">
      
        


  <h1>Dealing with NULL in PySpark transformations</h1>

<p>Lately I’ve been dealing with nested data on a semi regular basis with PySpark. One of the scenarios that tends to come
up a lot is to apply transformations to semi/unstructured data to generate a tabular dataset for consumption by data
scientist. When processing and transforming data I’ve previously found it beneficial to make use of the RDD data
structure so that I have the ability to easily apply custom transformations the same way I would if I was interacting
with normal Python data structures, but with the benefit of Spark and the functionality provided by the RDD API.</p>
<p>With my most recent project though I decided to spend more time working with the Spark Dataframe data structure
specifically for the potential performance gains from Catalyst and Tungeston. Along with this Spark offers a set of
complex types for Spark Dataframe columns to make interaction with collection types a little bit easier.</p>
<p>Diving in I immediately used the <a href="https://github.com/databricks/spark-xml">Databricks XML</a> library to load some data
into my dataframe which had a similar shape (although different contents) to this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">Row</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">explode</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">monotonicallyincreasingid</span><span class="p">,</span> <span class="n">when</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">lit</span>  
<span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.column</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">tojavacolumn</span>  

<span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span>  
 <span class="n">Row</span><span class="p">(</span><span class="n">dataCells</span><span class="o">=</span><span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="n">posx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">posy</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">posz</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;square&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">)]),</span>  
 <span class="n">Row</span><span class="p">(</span><span class="n">posx</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">posy</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">posz</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">4.5</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[]),</span>  
 <span class="n">Row</span><span class="p">(</span><span class="n">posx</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">posy</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">posz</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mf">7.5</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">Row</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s1">&#39;circle&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mf">.5</span><span class="p">)])</span>  
 <span class="p">])</span>  
<span class="p">])</span>  

<span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>  

 <span class="n">root</span>  
 <span class="o">|--</span> <span class="n">dataCells</span><span class="p">:</span> <span class="n">array</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|--</span> <span class="n">element</span><span class="p">:</span> <span class="n">struct</span> <span class="p">(</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">posx</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">posy</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">posz</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">shape</span><span class="p">:</span> <span class="n">array</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">element</span><span class="p">:</span> <span class="n">struct</span> <span class="p">(</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="nb">len</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="nb">type</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="n">value</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span><span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  

 <span class="o">+--------------------+</span>  
 <span class="o">|</span> <span class="n">dataCells</span><span class="o">|</span>  
 <span class="o">+--------------------+</span>  
 <span class="o">|</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="o">...|</span>  
 <span class="o">+--------------------+</span>
</code></pre></div>
<p>Perfect. Nothing too crazy, but I wanted to transform the nested array of structs into column representing the members
of each struct type. So I started by looking at the options available to flatten my array column and I came across which
appeared to do exactly what I needed. Next I needed to take the member attributes of the structs and turn those into
columns. I wasn’t able to find a built in function for this, but using the select syntax available on dataframes along
with the* wildcard available on structs I was able to write my own function to do this.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">flattenstructcols</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>  
 <span class="n">flatcols</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="k">if</span> <span class="s1">&#39;struct&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]]</span>  
 <span class="n">structcolumns</span> <span class="o">=</span> <span class="p">[</span><span class="n">column</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">dtypes</span> <span class="k">if</span> <span class="s1">&#39;struct&#39;</span> <span class="ow">in</span> <span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="mi">6</span><span class="p">]]</span>  

 <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">flatcols</span> <span class="o">+</span>  
 <span class="p">[</span><span class="n">col</span><span class="p">(</span><span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>  
 <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">structcolumns</span>  
 <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">sc</span> <span class="o">+</span> <span class="s1">&#39;.*&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>  

 <span class="k">return</span> <span class="n">dfAnd</span> <span class="k">with</span> <span class="n">that</span> <span class="n">out</span> <span class="n">of</span> <span class="n">the</span> <span class="n">way</span> <span class="n">I</span><span class="err">’</span><span class="n">m</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">go</span><span class="o">.</span>

<span class="n">flatdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">)))</span>  
<span class="n">flatdf</span> <span class="o">=</span> <span class="n">flattenstructcols</span><span class="p">(</span><span class="n">flatdf</span><span class="p">)</span>  
<span class="n">flatdf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  

 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>  
 <span class="o">|</span><span class="n">dataCellsposx</span><span class="o">|</span><span class="n">dataCellsposy</span><span class="o">|</span><span class="n">dataCellsposz</span><span class="o">|</span><span class="n">dataCellsshape</span><span class="o">|</span><span class="n">dataCellsvalue</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>  
 <span class="o">|</span> <span class="mi">0</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="p">]]</span><span class="o">|</span> <span class="mf">1.5</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mi">3</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[]</span><span class="o">|</span> <span class="mf">4.5</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">2</span><span class="o">|</span> <span class="mi">5</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[[,</span> <span class="n">circle</span><span class="p">]]</span><span class="o">|</span> <span class="mf">7.5</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>
 <span class="n">flatdf</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>  

 <span class="n">root</span>  
 <span class="o">|--</span> <span class="n">dataCellsposx</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|--</span> <span class="n">dataCellsposy</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|--</span> <span class="n">dataCellsposz</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|--</span> <span class="n">dataCellsshape</span><span class="p">:</span> <span class="n">array</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|--</span> <span class="n">element</span><span class="p">:</span> <span class="n">struct</span> <span class="p">(</span><span class="n">containsNull</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="nb">len</span><span class="p">:</span> <span class="n">long</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|</span> <span class="o">|</span> <span class="o">|--</span> <span class="nb">type</span><span class="p">:</span> <span class="n">string</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span>  
 <span class="o">|--</span> <span class="n">dataCellsvalue</span><span class="p">:</span> <span class="n">double</span> <span class="p">(</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">true</span><span class="p">)</span><span class="n">So</span> <span class="n">far</span> <span class="n">so</span> <span class="n">good</span><span class="o">.</span> <span class="n">Let</span><span class="err">’</span><span class="n">s</span> <span class="k">try</span> <span class="n">it</span> <span class="n">again</span><span class="p">,</span> <span class="ow">and</span> <span class="k">if</span> <span class="nb">all</span> <span class="n">goes</span> <span class="n">well</span> <span class="n">we</span> <span class="n">can</span> <span class="n">throw</span> <span class="n">this</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">loop</span><span class="p">,</span> <span class="n">flatten</span> <span class="n">nested</span> <span class="n">columns</span> <span class="ow">and</span> <span class="n">be</span> <span class="n">on</span> <span class="n">our</span> <span class="n">way</span><span class="o">.</span>

<span class="n">flatdf</span> <span class="o">=</span> <span class="n">flatdf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dataCellsshape&#39;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCellsshape&#39;</span><span class="p">)))</span>  
<span class="n">flatdf</span> <span class="o">=</span> <span class="n">flattenstructcols</span><span class="p">(</span><span class="n">flatdf</span><span class="p">)</span>  
<span class="n">flatdf</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  

 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>  
 <span class="o">|</span><span class="n">dataCellsposx</span><span class="o">|</span><span class="n">dataCellsposy</span><span class="o">|</span><span class="n">dataCellsposz</span><span class="o">|</span><span class="n">dataCellsvalue</span><span class="o">|</span><span class="n">dataCellsshapelen</span><span class="o">|</span><span class="n">dataCellsshapetype</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>  
 <span class="o">|</span> <span class="mi">0</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="mf">1.5</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="n">square</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">2</span><span class="o">|</span> <span class="mi">5</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="mf">7.5</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span> <span class="n">circle</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>
</code></pre></div>
<p>And now we have a problem. After back tracking I found that explode is silently dropping out my row with null in it.
Let's check
the <a href="https://spark.apache.org/docs/2.2.0/api/python/pyspark.sql.html?highlight=date#pyspark.sql.functions.explode">docs</a>.
Interestingly I didn't see anything about this. So I checked the latest docs and just so happened to
notice<a href="https://spark.apache.org/docs/latest/api/python/pyspark.sql.html?highlight=date#pyspark.sql.functions.explode_outer">explodeouter</a>
listed right below this. It turns out in 2.2.0 a set ofouter functions where added that retain null for certain
operations such as explode. Unfortunately some of these are not available in PySpark until 2.3 and I didn't have the
option to migrate from 2.2.x to 2.3.x.</p>
<p><a href="https://stackoverflow.com/questions/52747258/pyspark-2-2-explode-dropping-null-rows-how-to-implement-explode-outer">StackOverflow</a>
to the rescue. After reviewing the PySpark tag I didn't find any solutions with accepted answers so I went ahead and
wrote my own question. Thanks to that I learned a lot about PySpark/JVM interop and about some of the disparities
between the JVM API and other language APIs.</p>
<h3 id="otherwise">Otherwise()<a class="headerlink" href="#otherwise" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="n">flatdf</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">)))</span>  
<span class="n">flatdf</span> <span class="o">=</span> <span class="n">flattenstructcols</span><span class="p">(</span><span class="n">flatdf</span><span class="p">)</span>  
<span class="n">flatdf</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dataCellsshapetest&#39;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">when</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCellsshape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">(),</span> <span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCellsshape&#39;</span><span class="p">))</span>  
 <span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">array</span><span class="p">(</span><span class="n">lit</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">flatdf</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCellsshape&#39;</span><span class="p">)</span>  
 <span class="o">.</span><span class="n">getItem</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>  
 <span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])))))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  

<span class="o">+--------------|--------------|--------------|---------------|---------------|--------------------+</span>  
<span class="o">|</span><span class="n">dataCellsposx</span><span class="o">|</span><span class="n">dataCellsposy</span><span class="o">|</span><span class="n">dataCellsposz</span><span class="o">|</span><span class="n">dataCellsshape</span><span class="o">|</span><span class="n">dataCellsvalue</span><span class="o">|</span><span class="n">dataCellsshapetest</span><span class="o">|</span>  
<span class="o">+--------------|--------------|--------------|---------------|---------------|--------------------+</span>  
<span class="o">|</span> <span class="mi">0</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="p">]]</span><span class="o">|</span> <span class="mf">1.5</span><span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="p">]</span><span class="o">|</span>  
<span class="o">|</span> <span class="mi">2</span><span class="o">|</span> <span class="mi">5</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[[,</span> <span class="n">circle</span><span class="p">]]</span><span class="o">|</span> <span class="mf">7.5</span><span class="o">|</span> <span class="p">[,</span> <span class="n">circle</span><span class="p">]</span><span class="o">|</span>  
<span class="o">+--------------|--------------|--------------|---------------|---------------|--------------------+</span>
</code></pre></div>
<p>Based on some responses to my question I found another question that provided a scala solution involving .otherwise and
casting the nested structure with a null literal. None in Python. This seemed like the more direct solution without
making use of private functionality in the library, so I opted to try implementing the scala solution in PySpark first.</p>
<p>But unfortunately it appears that the explode may have a precedence behind the scenes that drops the row before
otherwise is evaluated. With a quickly approaching deadline I unfortunately did not have time to dig deep into why this
was with other options on the table.</p>
<h3 id="into-the-jvm">Into the JVM<a class="headerlink" href="#into-the-jvm" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">explodeouter</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>  
<span class="w"> </span><span class="sd">&quot;&quot;&quot;  </span>
<span class="sd"> Calling the explodeouter Java function from PySpark  </span>
<span class="sd"> &quot;&quot;&quot;</span>  
 <span class="n">explodeouter</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">jvm</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">explodeouter</span>  
 <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">explodeouter</span><span class="p">(</span><span class="n">tojavacolumn</span><span class="p">(</span><span class="n">col</span><span class="p">)))</span><span class="n">flatdfwithnull</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">,</span> <span class="n">explode</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s1">&#39;dataCells&#39;</span><span class="p">)))</span>  
<span class="n">flatdfwithnull</span> <span class="o">=</span> <span class="n">flattenstructcols</span><span class="p">(</span><span class="n">flatdfwithnull</span><span class="p">)</span>  
<span class="n">flatdfwithnull</span> <span class="o">=</span> <span class="n">flatdfwithnull</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;dataCellsshape&quot;</span><span class="p">,</span> <span class="n">explodeouter</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;dataCellsshape&quot;</span><span class="p">)))</span>  
<span class="n">flatdfwithnull</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  

 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>  
 <span class="o">|</span><span class="n">dataCellsposx</span><span class="o">|</span><span class="n">dataCellsposy</span><span class="o">|</span><span class="n">dataCellsposz</span><span class="o">|</span><span class="n">dataCellsshape</span><span class="o">|</span><span class="n">dataCellsvalue</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>  
 <span class="o">|</span> <span class="mi">0</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">square</span><span class="p">]</span><span class="o">|</span> <span class="mf">1.5</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mi">3</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span> <span class="mf">4.5</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">2</span><span class="o">|</span> <span class="mi">5</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="p">[,</span> <span class="n">circle</span><span class="p">]</span><span class="o">|</span> <span class="mf">7.5</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|---------------+</span>
 <span class="n">flatdfwithnull</span> <span class="o">=</span> <span class="n">flattenstructcols</span><span class="p">(</span><span class="n">flatdfwithnull</span><span class="p">)</span>  
<span class="n">flatdfwithnull</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  

 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>  
 <span class="o">|</span><span class="n">dataCellsposx</span><span class="o">|</span><span class="n">dataCellsposy</span><span class="o">|</span><span class="n">dataCellsposz</span><span class="o">|</span><span class="n">dataCellsvalue</span><span class="o">|</span><span class="n">dataCellsshapelen</span><span class="o">|</span><span class="n">dataCellsshapetype</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>  
 <span class="o">|</span> <span class="mi">0</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="mf">1.5</span><span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="n">square</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">1</span><span class="o">|</span> <span class="mi">3</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="mf">4.5</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span>  
 <span class="o">|</span> <span class="mi">2</span><span class="o">|</span> <span class="mi">5</span><span class="o">|</span> <span class="mf">0.5</span><span class="o">|</span> <span class="mf">7.5</span><span class="o">|</span> <span class="n">null</span><span class="o">|</span> <span class="n">circle</span><span class="o">|</span>  
 <span class="o">+--------------|--------------|--------------|---------------|--------------------|---------------------+</span>
</code></pre></div>
<p>While reviewing suggested solutions I found out that SparkContext has ajvm object that provides access to org.apache.*
functionality. Along with this I also noticed that Databricks has an entire "private" api used with Python and Java.
Part of this API istojavacolumn which makes it possible to transform a PySpark column to a Java column to match Java
method signatures.
Learning all of this, and knowing that the Java API already had <code>explodeouter</code> implemented I reviewed the
Java <a href="https://spark.apache.org/docs/2.3.0/api/java/index.html">explodeouter</a> method to verify the type signature and
built my own function in Python to call the Java function and return the column with null in place.</p>
<p>And it works! With that I am able to flatten out arbitrarily nested collections in PySpark dataframes while retaining
nulls when using Spark 2.2.x.</p>
<h3 id="wrapping-up">Wrapping Up<a class="headerlink" href="#wrapping-up" title="Permanent link">&para;</a></h3>
<p>A couple of things to note; if you have an array with more than one struct as a member this will fail, and if you have a
deeply nested structure the growth of this transformation is typically not sustainable on a large dataset.</p>
<p>I have questions that I hope to continue spending time on. For instance why are rows with null dropped at all? I wonder
if the operation makes a new dataframe from the column to apply the operation to and then joins it back on an index and
along the way that join loses nulls. Why are functions that are lossy not identified as such? Is there always a version
lag between the JVM api and the PySpark api? I'm also curious how Catalyst handles denesting operations and adding new
columns from the result of exploding arrays or flattening structs.</p>
<p>Finally instead of adding new columns I want to try using the MapType to instead create a new column of key, value pairs
that allows me to flatten out arbitrarily deep collections into a MapType so that I can use the same methodology on much
deeper structures without adding a lot of columns that are mostly null.</p>







  
  




  



      
    </article>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="/feed_rss_updated.xml" target="_blank" rel="noopener" title="RSS Feed" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M0 64c0-17.7 14.3-32 32-32 229.8 0 416 186.2 416 416 0 17.7-14.3 32-32 32s-32-14.3-32-32C384 253.6 226.4 96 32 96 14.3 96 0 81.7 0 64m0 352a64 64 0 1 1 128 0 64 64 0 1 1-128 0m32-256c159.1 0 288 128.9 288 288 0 17.7-14.3 32-32 32s-32-14.3-32-32c0-123.7-100.3-224-224-224-17.7 0-32-14.3-32-32s14.3-32 32-32"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["navigation.path", "icons"], "search": "../../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
      
    
  </body>
</html>